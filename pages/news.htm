url = "/news/:slug?|[a-zA-Z\-0-9]"
layout = "default"
title = "News"


[menu tabs_menu]
start = "id-13"
activeNode = 0
listItemClasses = "item"
primaryClasses = "nav nav-pills"
secondaryClasses = "dropdown-menu"
numberOfLevels = 2

==
<?php
use Pensoft\Articles\Models\Category;
use Pensoft\Articles\Models\Article;

function onStart()
{
    $article = Pensoft\Articles\Models\Article::where('slug', $this->param('slug'))->first();

    if($article){
        $this['nextArticle'] = Article::where('id', '>', $article->id)
                                      ->where('published', 'true')
                                      ->where('published_at', '<=', 'now')
                                      ->orderBy('id', 'asc')
                                      ->first();

        $this['previousArticle'] = Article::where('id', '<', $article->id)
                                          ->where('published', 'true')
                                          ->where('published_at', '<=', 'now')
                                          ->orderBy('id', 'desc')
                                          ->first();
    }

    $this['article'] = $article;
    $this['categories'] = Category::whereNotIn('id', [9, 10, 11, 12, 13, 14, 15])->orderBy('sort_order')->orderBy('created_at', 'desc')->get();

    $categoryId = input('categoryId', 'all');

    if ($categoryId !== 'all' && !is_numeric($categoryId)) {
        return redirect('news');
    }

    $this['categoryId'] = $categoryId;

    if ($categoryId === 'all') {
        $records = Article::news()->where('published_at', '<=', 'now')
                                  ->where('published', 'true')
                                  ->orderBy('published_at', 'DESC')
                                  ->paginate(12);
    } else {
        $records = Article::news()->whereHas('categories', function ($query) use ($categoryId) {
                     $query->where('id', $categoryId);
                 })->where('published_at', '<=', 'now')
                   ->where('published', 'true')
                   ->orderBy('published_at', 'DESC')
                   ->paginate(12);
    }

    if ($categoryId !== 'all') {
        $records->appends(['categoryId' => $categoryId]);
    }

    $this['records'] = $records;

    if($this['article']) {
        $this['is_detail_page'] = true;
        $this['allow_share'] = $this['article']['allow_share'] == 'yes' ? true : false;

        if($this['is_detail_page']) {
            $seoTitle = $this['article']['title'];
            $seoKeywords = $this['article']['meta_keywords'] ?: $this['article']['keywords'];
            $seoDescription = str_limit(Html::strip($this['article']['content']), 255);

            if (class_exists('\BennoThommo\Meta\Meta')) {
                \BennoThommo\Meta\Meta::set('title', $seoTitle);
                \BennoThommo\Meta\Meta::set('keywords', $seoKeywords);
                \BennoThommo\Meta\Meta::set('description', $seoDescription);
            }
        }

        if($this['allow_share']) {
            $this['page_url'] = $this->pageUrl('');
            $this['encoded_title'] = urlencode($this['article']['title']);
            $this['slug'] = $this['article']['slug'];
            \BennoThommo\Meta\Meta::set('twitter:card', 'summary_large_image');
            \BennoThommo\Meta\Meta::set('twitter:title', $this['article']['title']);
            \BennoThommo\Meta\Meta::set('twitter:description', str_limit(Html::strip($this['article']['content']), 255));
            \BennoThommo\Meta\Meta::set('og:title', $this['article']['title']);
            \BennoThommo\Meta\Meta::set('og:description', str_limit(Html::strip($this['article']['content']), 255));
            \BennoThommo\Meta\Meta::set('og:type', 'article');
            \BennoThommo\Meta\Meta::set('og:url', $this->pageUrl(''));

            if ($this['article']['cover']) {
                \BennoThommo\Meta\Meta::set('twitter:image', $this['article']['cover']->getThumb(600, null, ['mode' => 'auto']));
                \BennoThommo\Meta\Meta::set('og:image', $this['article']['cover']->getThumb(600, 314, ['mode' => 'crop']));
                \BennoThommo\Meta\Meta::set('og:image:width', 600);
                \BennoThommo\Meta\Meta::set('og:image:height', 314);
            }
        }



        if($this['is_detail_page']){
            $related = array();
            if($this['article']['slug']){
                $article = Article::where('slug', $this['article']['slug'])->first();
                $arrayOfTags = explode(",", $article->keywords);

                $related = Article::where('slug', '!=', $this['article']['slug']);

                $orWhere = '( ';
                $c = 1;

                foreach($arrayOfTags as $tag){
                    $orWhere .= ' keywords ILIKE \'%'.trim($tag).'%\' ';
                    if($c < count($arrayOfTags)){
                        $orWhere .= ' or ';
                    }
                    $c++;
                }
                $orWhere .= ')';
                $related = $related
                ->whereRaw($orWhere)
                ->limit(3)
                ->get();

            $this['related'] = $related;
            }
        }


    }
}
?>
==
{% if is_detail_page %}



<article class="single-news-item" role="main" aria-labelledby="article-title">
    <main id="main-content" class="container" role="main">
        <div class="go-back-link"><a href="/news">Return to the news list</a></div>

        <div class="row">
            <div class="col-md-8 col-xs-12">
                <div class="intro-section">
                    <div role="complementary" aria-label="Article information">
                        <!-- Date -->
                        <div class="event-sidebar__item">
                            <div class="event-sidebar__icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M5.83317 1.45825C6.17835 1.45825 6.45817 1.73807 6.45817 2.08325V2.71885C7.00986 2.70824 7.61767 2.70825 8.28616 2.70825H11.7135C12.382 2.70825 12.9898 2.70824 13.5415 2.71885V2.08325C13.5415 1.73807 13.8213 1.45825 14.1665 1.45825C14.5117 1.45825 14.7915 1.73807 14.7915 2.08325V2.77249C15.0081 2.78901 15.2133 2.80977 15.4074 2.83586C16.3844 2.96722 17.1752 3.24399 17.7988 3.86762C18.4224 4.49126 18.6992 5.28205 18.8306 6.25907C18.8725 6.57131 18.9007 6.91207 18.9196 7.28331C18.9445 7.3508 18.9582 7.42376 18.9582 7.49992C18.9582 7.55769 18.9503 7.61362 18.9357 7.66672C18.9582 8.33504 18.9582 9.09388 18.9582 9.95291V11.7136C18.9582 13.2451 18.9582 14.4581 18.8306 15.4074C18.6992 16.3845 18.4224 17.1752 17.7988 17.7989C17.1752 18.4225 16.3844 18.6993 15.4074 18.8306C14.458 18.9583 13.245 18.9583 11.7135 18.9583H8.28616C6.75469 18.9583 5.54166 18.9583 4.59232 18.8306C3.6153 18.6993 2.82451 18.4225 2.20087 17.7989C1.57724 17.1752 1.30047 16.3845 1.16912 15.4074C1.04148 14.4581 1.04149 13.2451 1.0415 11.7136V9.9529C1.0415 9.09388 1.04149 8.33504 1.06401 7.66673C1.04934 7.61362 1.0415 7.55769 1.0415 7.49992C1.0415 7.42377 1.05512 7.35079 1.08006 7.2833C1.09897 6.91207 1.12714 6.57131 1.16912 6.25907C1.30047 5.28205 1.57724 4.49126 2.20087 3.86762C2.82451 3.24398 3.6153 2.96722 4.59232 2.83586C4.78642 2.80977 4.99155 2.78901 5.20817 2.77249V2.08325C5.20817 1.73807 5.48799 1.45825 5.83317 1.45825ZM2.30241 8.12492C2.29177 8.66886 2.2915 9.28824 2.2915 9.99992V11.6666C2.2915 13.2556 2.29283 14.3845 2.40797 15.2409C2.52069 16.0793 2.73208 16.5623 3.08476 16.915C3.43743 17.2677 3.92047 17.4791 4.75888 17.5918C5.61526 17.7069 6.74415 17.7083 8.33317 17.7083H11.6665C13.2555 17.7083 14.3844 17.7069 15.2408 17.5918C16.0792 17.4791 16.5622 17.2677 16.9149 16.915C17.2676 16.5623 17.479 16.0793 17.5917 15.2409C17.7068 14.3845 17.7082 13.2556 17.7082 11.6666V9.99992C17.7082 9.28824 17.7079 8.66886 17.6973 8.12492H2.30241ZM17.6401 6.87492H2.35957C2.37292 6.71709 2.38888 6.56761 2.40797 6.42563C2.52069 5.58722 2.73208 5.10418 3.08476 4.7515C3.43743 4.39883 3.92047 4.18744 4.75888 4.07472C5.61527 3.95958 6.74415 3.95825 8.33317 3.95825H11.6665C13.2555 3.95825 14.3844 3.95958 15.2408 4.07472C16.0792 4.18744 16.5622 4.39883 16.9149 4.7515C17.2676 5.10418 17.479 5.58722 17.5917 6.42563C17.6108 6.56761 17.6268 6.71709 17.6401 6.87492Z" fill="white"/>
                                </svg>
                            </div>
                            <div class="event-sidebar__text">
                                <time datetime="{{article.published_at|date('c')}}" aria-label="Published on">
                                    {{ article.published_at|date("d M Y") }}
                                </time>
                            </div>
                        </div>
                    </div>
                </div>

                <header>
                    <div class="news-title">
                        <h1 id="event-title" class="single-new-title">{{article.title}}</h1>
                    </div>
                </header>


                <section class="body-content" aria-labelledby="article-content-heading">
                    <h2 id="article-content-heading" class="sr-only">Article Content</h2>
                    {% if article.content %}
                    <div class="article-body" role="document">
                        {{ article.content|raw }}
                    </div>
                    {% endif %}
                </section>

            </div>
            <div class="col-md-4 col-xs-12">

                <div class="img-container">
                    {% if article.cover %}
                    <img src="{{ article.cover.path }}"
                         alt="Featured image for {{ article.title }}"
                         role="img"
                         aria-describedby="article-title"/>
                    {% endif %}
                </div>
            </div>
        </div>




        <div class="row related_articles_news">

                <div class="col-xs-12">
                    <h2>Related articles</h2>
                </div>

                {% for highlight in related %}
            <article class="col-xs-12 col-md-4 news-item item-{{highlight.slug}}"
                     role="listitem"
                     aria-labelledby="article-title-{{highlight.slug}}">

                <div class="row news_column">
                    <!-- Article Image -->
                    <div class="news-image col-xs-12 center-xs">
                        <a href="{{'news'|page}}/{{highlight.slug}}"
                           aria-describedby="article-image-{{highlight.slug}}-desc"
                           tabindex="0">
                            {% if highlight.cover %}
                            <img class="news-img-top"
                                 src="{{highlight.cover.getThumb(auto, 311, {'mode': 'crop'})}}"
                                 alt="Cover image for article: {{ highlight.title }}"
                                 role="img"
                                 loading="lazy"
                                 width="370"
                                 height="212">
                            {% else %}
                            <img class="news-img-top"
                                 src="{{'pensoft/No_Image_Available.jpg'|media }}"
                                 alt="No image available for article: {{ highlight.title }}"
                                 role="img"
                                 loading="lazy">
                            {% endif %}
                        </a>
                        <span id="article-image-{{highlight.slug}}-desc" class="sr-only">
                        View full article: {{ highlight.title }}
                    </span>
                    </div>

                    <!-- Article Content -->
                    <div class="news-container col-xs-12">
                        <!-- Publication Date -->
                        <time class="text-published"
                              datetime="{{ highlight.published_at|date('c') }}"
                              aria-label="Published on">
                            {{ highlight.published_at|date("d M Y") }}
                        </time>

                        <!-- Article Title -->
                        <header class="news-title">
                            <h3 class="card-title" id="article-title-{{highlight.slug}}">
                                <a href="{{'news'|page}}/{{highlight.slug}}"
                                   aria-describedby="article-context-{{highlight.slug}}">
                                    {{ highlight.title|length > 99 ? highlight.title|slice(0, 99) ~ '...' : highlight.title }}
                                    {% if highlight.title|length > 99 %}
                                    <span class="sr-only"> (title truncated)</span>
                                    {% endif %}
                                </a>
                            </h3>
                            <span id="article-context-{{highlight.slug}}" class="sr-only">
                            Published {{ highlight.published_at|date("d M Y") }}. Click to read full article.
                        </span>
                        </header>

                        <!-- Action and Sharing Row -->
                        <div class="row article-actions" role="group" aria-label="Article actions">
                            <!-- Read Article Button -->
                            <div class="col-xs-6">
                                <a href="{{'news'|page}}/{{highlight.slug}}"
                                   class="btn btn-primary read-article-btn"
                                   aria-describedby="read-article-{{highlight.slug}}-desc">
                                    {{'Read article'|_}}
                                </a>
                                <span id="read-article-{{highlight.slug}}-desc" class="sr-only">
                                Read the full article: {{ highlight.title }}
                            </span>
                            </div>

                            <!-- Social Sharing -->
                            <div class="col-xs-6">
                                {% if allow_share == 'yes' %}
                                <nav class="social-sharing"
                                     aria-labelledby="share-{{highlight.slug}}-heading"
                                     role="navigation">
                                    <h4 id="share-{{highlight.slug}}-heading" class="sr-only">
                                        Share {{ highlight.title }}
                                    </h4>

                                    <ul class="social-sharing-list" role="list" aria-label="Social media sharing options">
                                        {% if this.theme.twitter %}
                                        <li role="listitem">
                                            <a href="https://twitter.com/intent/tweet?text={{highlight.title_encoded}}{{'news'|page}}/{{highlight.slug}}"
                                               target="_blank"
                                               rel="noopener noreferrer"
                                               class="col-xs col-md-12 btn p-primary pr p-twitter big social-share-btn"
                                               aria-describedby="twitter-share-{{highlight.slug}}-desc">
                                                <span class="sr-only">Share on Twitter</span>
                                                <span class="social-icon twitter-icon" aria-hidden="true"></span>
                                            </a>
                                            <span id="twitter-share-{{highlight.slug}}-desc" class="sr-only">
                                            Share "{{ highlight.title }}" on Twitter (opens in new window)
                                        </span>
                                        </li>
                                        {% endif %}

                                        {% if this.theme.facebook %}
                                        <li role="listitem">
                                            <a href="https://www.facebook.com/sharer/sharer.php?u={{'news'|page}}/{{highlight.slug}}&amp;src=sdkpreparse"
                                               target="_blank"
                                               rel="noopener noreferrer"
                                               class="col-xs col-md-12 btn pr p-primary p-facebook big social-share-btn"
                                               aria-describedby="facebook-share-{{highlight.slug}}-desc">
                                                <span class="sr-only">Share on Facebook</span>
                                                <span class="social-icon facebook-icon" aria-hidden="true"></span>
                                            </a>
                                            <span id="facebook-share-{{highlight.slug}}-desc" class="sr-only">
                                            Share "{{ highlight.title }}" on Facebook (opens in new window)
                                        </span>
                                        </li>
                                        {% endif %}

                                        {% if this.theme.linkedin %}
                                        <li role="listitem">
                                            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{'news'|page}}/{{highlight.slug}}"
                                               target="_blank"
                                               rel="noopener noreferrer"
                                               class="col-xs col-md-12 btn pr p-primary p-linkedin big social-share-btn"
                                               aria-describedby="linkedin-share-{{highlight.slug}}-desc">
                                                <span class="sr-only">Share on LinkedIn</span>
                                                <span class="social-icon linkedin-icon" aria-hidden="true"></span>
                                            </a>
                                            <span id="linkedin-share-{{highlight.slug}}-desc" class="sr-only">
                                            Share "{{ highlight.title }}" on LinkedIn (opens in new window)
                                        </span>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </article>
                {% endfor %}
        </div>


    </main>
</article>

{% else %}
<!-- News List View -->

<main id="main-content" class="container pt-0 mt-0" role="main" aria-labelledby="news-page-title">


    <div class="container">
        <div class="category-tabs">
            {% component 'tabs_menu' %}
        </div>
    </div>


    <header class="news-page-header">
        <h1 id="news-page-title" class="text-center mb-4">
            Keep up to date with the latest news from the BioAgora project!
        </h1>
    </header>

    {% if categories.count > 0 %}
    <nav class="category-tabs-container mb-2"
         role="navigation"
         aria-labelledby="category-filter-heading">
        <h2 id="category-filter-heading" class="sr-only">Filter news by category</h2>
        <div class="row category-tabs-sub"
             id="category-tabs"
             role="tablist"
             aria-label="News categories">
            <a href="{{ 'news'|page }}"
               role="tab"
               class="category-tab {{ 'all' == categoryId ? 'active' : '' }}"
               aria-selected="{{ 'all' == categoryId ? 'true' : 'false' }}"
               aria-describedby="all-news-desc">
                All News
            </a>
            <span id="all-news-desc" class="sr-only">View all news articles</span>

            {% for category in categories %}
            <a href="{{ 'news'|page }}?categoryId={{ category.id }}"
               role="tab"
               class="category-tab {{ category.id == categoryId ? 'active' : '' }}"
               aria-selected="{{ category.id == categoryId ? 'true' : 'false' }}"
               aria-describedby="category-{{ category.id }}-desc">
                {{ category.name }}
            </a>
            <span id="category-{{ category.id }}-desc" class="sr-only">
                View news articles in {{ category.name }} category
            </span>
            {% endfor %}
        </div>
    </nav>
    {% endif %}

    <section class="newslist-records"
             id="newslist-records"
             aria-labelledby="news-list-heading"
             role="region">
        <h2 id="news-list-heading" class="sr-only">News Articles List</h2>
        {% partial 'components/newslist-records' %}
    </section>

    <nav class="pagination-container"
         role="navigation"
         aria-label="News pagination">
        <div class="row container">
            {{ records.render|raw }}
        </div>
    </nav>
</main>

<!--<div class="container flower-bg" aria-hidden="true" role="presentation"></div>-->
{% endif %}
